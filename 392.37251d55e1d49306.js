"use strict";(self.webpackChunkapp=self.webpackChunkapp||[]).push([[392],{392:(at,P,h)=>{h.r(P),h.d(P,{PosSalesPageModule:()=>st});var v=h(9808),L=h(4182),a=h(4881),q=h(4030),I=h(655),M=h(4441),t=h(9863),H=h(2313),Q=h(7158),N=h(5465),O=h(849),F=h(1472);const U=["dst"],k=["dstPop"],J=["qtyId"],R=["popInput"],Y=["popover"],B=["popoverNotif"];function D(n,c){if(1&n){const e=t.EpF();t.TgZ(0,"ion-item",21),t.TgZ(1,"ion-input",22),t.NdJ("keyup.enter",function(){t.CHM(e);const s=t.oxw(3);return s.editCellPop(s.cellIndex)})("ngModelChange",function(s){t.CHM(e);const o=t.oxw(3);return o.itemList[o.cellIndex].quantity=s})("ionBlur",function(){t.CHM(e);const s=t.oxw(3);return s.editCell(s.cellIndex)}),t.qZA(),t.qZA()}if(2&n){const e=t.oxw(3);t.xp6(1),t.Q6J("ngModel",e.itemList[e.cellIndex].quantity)}}function E(n,c){if(1&n){const e=t.EpF();t.TgZ(0,"ion-item",23),t.NdJ("click",function(){const o=t.CHM(e).$implicit,r=t.oxw(3);return r.editCellPop(r.cellIndex,o)}),t.TgZ(1,"ion-grid"),t.TgZ(2,"ion-row"),t.TgZ(3,"ion-col",24),t.TgZ(4,"ion-label"),t.TgZ(5,"ion-text",25),t._uU(6),t.qZA(),t.qZA(),t.qZA(),t.qZA(),t.qZA(),t.qZA()}if(2&n){const e=c.$implicit;t.xp6(6),t.hij(" ",e,"")}}function G(n,c){if(1&n&&(t.TgZ(0,"ion-header"),t.TgZ(1,"ion-toolbar",17),t.YNc(2,D,2,1,"ion-item",18),t.qZA(),t.qZA(),t.TgZ(3,"ion-content",4),t.TgZ(4,"ion-list",19),t.YNc(5,E,7,1,"ion-item",20),t.qZA(),t.qZA()),2&n){const e=t.oxw(2);t.xp6(2),t.Q6J("ngIf",e.showMe==e.cellIndex),t.xp6(3),t.Q6J("ngForOf",e.NumberArray)}}function z(n,c){if(1&n){const e=t.EpF();t.TgZ(0,"tr",26),t.NdJ("click",function(s){const r=t.CHM(e).index;return t.oxw(2).presentPopoverQtyPop(s,r)}),t.TgZ(1,"td"),t.TgZ(2,"ion-button",27),t.NdJ("click",function(){const o=t.CHM(e).index;return t.oxw(2).deleteItem(o)}),t._UZ(3,"ion-icon",28),t.qZA(),t.qZA(),t.TgZ(4,"td",29),t._uU(5),t.qZA(),t.TgZ(6,"td"),t.TgZ(7,"ion-text"),t._uU(8),t.qZA(),t.qZA(),t.TgZ(9,"td"),t.TgZ(10,"ion-text"),t._uU(11),t.qZA(),t.qZA(),t.TgZ(12,"td"),t.TgZ(13,"ion-text"),t._uU(14),t.qZA(),t.qZA(),t.TgZ(15,"td"),t.TgZ(16,"ion-text"),t._uU(17),t.qZA(),t.qZA(),t.TgZ(18,"td"),t._uU(19),t.qZA(),t.qZA()}if(2&n){const e=c.$implicit;t.xp6(5),t.hij(" ",e.item_name," "),t.xp6(3),t.Oqu(e.quantity),t.xp6(3),t.Oqu(+e.pay_price),t.xp6(3),t.hij("",+e.tax," "),t.xp6(3),t.Oqu(+e.discount),t.xp6(2),t.Oqu(+e.tot)}}function V(n,c){if(1&n&&(t.TgZ(0,"ion-segment-button",35),t._uU(1),t.qZA()),2&n){const e=c.$implicit;t.Q6J("value",e.brand),t.xp6(1),t.hij(" ",e.brand," ")}}function j(n,c){if(1&n){const e=t.EpF();t.TgZ(0,"ion-col",37),t.TgZ(1,"div",38),t._uU(2),t.qZA(),t.TgZ(3,"ion-card",39),t.NdJ("click",function(){const o=t.CHM(e).$implicit;return t.oxw(4).addTolistClick(o)}),t._UZ(4,"img",40),t.qZA(),t.TgZ(5,"div",41),t.TgZ(6,"p",19),t._uU(7),t.qZA(),t.qZA(),t.qZA()}if(2&n){const e=c.$implicit;t.xp6(2),t.Oqu(+e.pay_price+ +e.tax/100*+e.pay_price),t.xp6(2),t.Q6J("src",e.imgUrl,t.LSH),t.xp6(3),t.hij(" ",e.item_name," ")}}function W(n,c){if(1&n&&(t.TgZ(0,"ion-row"),t.YNc(1,j,8,3,"ion-col",36),t.qZA()),2&n){const e=t.oxw(3);t.xp6(1),t.Q6J("ngForOf",e.filteredItems)}}function $(n,c){if(1&n){const e=t.EpF();t.TgZ(0,"ion-row",30),t.TgZ(1,"ion-card",31),t.TgZ(2,"ion-segment",32),t.NdJ("ionChange",function(s){return t.CHM(e),t.oxw(2).segmentChanged(s)}),t.YNc(3,V,2,2,"ion-segment-button",33),t.qZA(),t.TgZ(4,"ion-grid",34),t.YNc(5,W,2,1,"ion-row",3),t.qZA(),t.qZA(),t.qZA()}if(2&n){const e=t.oxw(2);t.xp6(3),t.Q6J("ngForOf",e.brandList),t.xp6(2),t.Q6J("ngIf",e.filteredItems.length>0)}}function K(n,c){if(1&n){const e=t.EpF();t.TgZ(0,"ion-grid"),t.TgZ(1,"ion-row",4),t.TgZ(2,"ion-col",6),t.TgZ(3,"ion-grid"),t.TgZ(4,"ion-row"),t.TgZ(5,"ion-col",7),t.TgZ(6,"ion-card",8),t.TgZ(7,"ion-popover",9,10),t.NdJ("didDismiss",function(){return t.CHM(e),t.oxw().didDissmisQtPop()}),t.YNc(9,G,6,2,"ng-template"),t.qZA(),t.TgZ(10,"table",11),t.TgZ(11,"tr"),t._UZ(12,"th"),t.TgZ(13,"th"),t._uU(14,"\u0627\u0644\u0635\u0646\u0641"),t.qZA(),t.TgZ(15,"th"),t._uU(16,"\u0627\u0644\u0643\u0645\u064a\u0629"),t.qZA(),t.TgZ(17,"th"),t._uU(18,"\u0633\u0639\u0631 \u0627\u0644\u0648\u062d\u062f\u0629 "),t.qZA(),t.TgZ(19,"th"),t._uU(20,"\u0627\u0644\u0636\u0631\u064a\u0628\u0629 "),t.qZA(),t.TgZ(21,"th"),t._uU(22,"\u0627\u0644\u062e\u0635\u0645 "),t.qZA(),t.TgZ(23,"th"),t._uU(24,"\u0627\u0644\u0645\u062c\u0645\u0648\u0639"),t.qZA(),t.qZA(),t.YNc(25,z,20,6,"tr",12),t.qZA(),t.qZA(),t.TgZ(26,"ion-card"),t.TgZ(27,"ion-grid"),t.TgZ(28,"ion-row"),t.TgZ(29,"ion-col",13),t.TgZ(30,"ion-label"),t.TgZ(31,"strong"),t._uU(32,"\u0635\u0627\u0641\u064a \u0627\u0644\u0645\u0628\u0644\u063a "),t.qZA(),t.qZA(),t._UZ(33,"br"),t.TgZ(34,"ion-label"),t.TgZ(35,"ion-text"),t._uU(36),t.qZA(),t.qZA(),t.qZA(),t.TgZ(37,"ion-col",13),t.TgZ(38,"ion-label"),t.TgZ(39,"strong"),t._uU(40,"\u0627\u0644\u062e\u0635\u0640\u0640\u0645 "),t.qZA(),t._UZ(41,"br"),t.TgZ(42,"ion-text"),t._uU(43),t.qZA(),t.qZA(),t.qZA(),t.TgZ(44,"ion-col",13),t.TgZ(45,"ion-label"),t.TgZ(46,"strong"),t._uU(47,"\u0627\u0644\u0636\u0631\u064a\u0628\u0629 "),t.qZA(),t.qZA(),t._UZ(48,"br"),t.TgZ(49,"ion-label"),t.TgZ(50,"ion-text"),t._uU(51),t.qZA(),t.qZA(),t.qZA(),t.TgZ(52,"ion-col",14),t.TgZ(53,"ion-label"),t.TgZ(54,"strong"),t._uU(55," \u0627\u0644\u0645\u062c\u0645\u0648\u0639 "),t.qZA(),t.qZA(),t._UZ(56,"br"),t.TgZ(57,"ion-label"),t.TgZ(58,"ion-text"),t._uU(59),t.qZA(),t.qZA(),t.qZA(),t.qZA(),t.qZA(),t.qZA(),t.qZA(),t.TgZ(60,"ion-col",15),t.YNc(61,$,6,2,"ion-row",16),t.qZA(),t.qZA(),t.qZA(),t.qZA(),t.qZA(),t.qZA()}if(2&n){const e=t.oxw();t.xp6(7),t.Q6J("isOpen",e.isOpenNotif),t.xp6(18),t.Q6J("ngForOf",e.itemList),t.xp6(11),t.hij("",e.payInvo.tot_pr," "),t.xp6(7),t.hij("",e.payInvo.discountTot," "),t.xp6(8),t.hij("",e.payInvo.taxTot," "),t.xp6(8),t.hij("",e.taxAll," "),t.xp6(2),t.Q6J("ngIf",e.brandList.length>0)}}function X(n,c){if(1&n){const e=t.EpF();t.TgZ(0,"ion-row",42),t.TgZ(1,"ion-col",43),t.TgZ(2,"ion-grid",4),t.TgZ(3,"ion-row"),t.TgZ(4,"ion-col",44),t.TgZ(5,"ion-radio-group",45),t.NdJ("ngModelChange",function(s){return t.CHM(e),t.oxw().payInvo.pay_method=s}),t.TgZ(6,"ion-item",46),t.TgZ(7,"ion-label",47),t._uU(8,"\u0646\u0642\u062f\u0627"),t.qZA(),t._UZ(9,"ion-radio",48),t.TgZ(10,"ion-label",47),t._uU(11,"\u0628\u0637\u0627\u0642\u0629"),t.qZA(),t._UZ(12,"ion-radio",49),t.qZA(),t.qZA(),t.qZA(),t.TgZ(13,"ion-col",50),t.TgZ(14,"ion-label",51),t.TgZ(15,"strong"),t._uU(16," \u0627\u0644\u0645\u0633\u062a\u0644\u0645 \u0646\u0642\u062f\u0627 "),t.qZA(),t.qZA(),t.TgZ(17,"ion-item",21),t.TgZ(18,"ion-input",52),t.NdJ("ngModelChange",function(s){return t.CHM(e),t.oxw().payInvo.pay=s})("ionChange",function(s){return t.CHM(e),t.oxw().payChange(s)}),t.qZA(),t.qZA(),t.qZA(),t.TgZ(19,"ion-col",50),t.TgZ(20,"ion-label",51),t.TgZ(21,"strong"),t._uU(22," \u0627\u0644\u062e\u0635\u0640\u0640\u0645"),t.qZA(),t.qZA(),t.TgZ(23,"ion-item",21),t.TgZ(24,"ion-input",52),t.NdJ("ngModelChange",function(s){return t.CHM(e),t.oxw().payInvo.discount=s})("ionChange",function(s){return t.CHM(e),t.oxw().discountChange(s)}),t.qZA(),t.qZA(),t.qZA(),t.TgZ(25,"ion-col",50),t.TgZ(26,"ion-label",51),t.TgZ(27,"strong"),t._uU(28,"\u0627\u0644\u0645\u062a\u0628\u0642\u064a "),t.qZA(),t.qZA(),t.TgZ(29,"ion-item",21),t.TgZ(30,"ion-input",53),t.NdJ("ngModelChange",function(s){return t.CHM(e),t.oxw().payInvo.changee=s}),t.qZA(),t.qZA(),t.qZA(),t.qZA(),t.qZA(),t.qZA(),t.TgZ(31,"ion-col",50),t.TgZ(32,"ion-button",54),t.NdJ("click",function(){return t.CHM(e),t.oxw().save()}),t._UZ(33,"ion-icon",55),t.TgZ(34,"ion-label",19),t._uU(35," OK "),t.qZA(),t.qZA(),t.qZA(),t.qZA()}if(2&n){const e=t.oxw();t.xp6(5),t.Q6J("ngModel",e.payInvo.pay_method),t.xp6(13),t.Q6J("ngModel",e.payInvo.pay),t.xp6(6),t.Q6J("ngModel",e.payInvo.discount),t.xp6(6),t.Q6J("ngModel",e.payInvo.changee)("readonly",!0)}}const tt=[{path:"",component:(()=>{class n{constructor(e,i,s,o,r,l,d,b,m,y,x,g,A,f,_,T){this.menuCtrl=e,this.sanitizer=i,this.rout=s,this.platform=o,this.behavApi=r,this._location=l,this.route=d,this.renderer=b,this.modalController=m,this.alertController=y,this.authenticationService=x,this.storage=g,this.loadingController=A,this.datePipe=f,this.api=_,this.toast=T,this.isOpen=!1,this.isOpenNotif=!1,this.newNotif=!1,this.sub_account=[],this.sub_accountLocalSales=[],this.sub_accountSales=[],this.initialInvoices=[],this.items=[],this.itemsLocal=[],this.itemList=[],this.salesLocal=[],this.sales=[],this.notifArr=[],this.LogHistoryLocalArr=[],this.purchLocal=[],this.purchase=[],this.randomsNumber=[],this.sub_nameNew="",this.discountPerc=0,this.NumberArray=[1,2,3,4,5,6,7,8,10],this.radioVal=0,this.radioVal2=0,this.printMode=!1,this.printArr=[],this.offline=!1,this.color="dark",this.showMe=null,this.cellIndex=null,this.status="new",this.searchLang=0,this.searchTerm="",this.aliasTerm="",this.searchResult=[],this.aliasResult=[],this.finalResult=[],this.loadingItems=!1,this.logHistoryArr=[],this.showNotif=!1,this.device="",this.currenQty=0,this.firstQty=0,this.perchTotQty=0,this.payTotQty=0,this.perchTot=0,this.qtyReal=0,this.availQty=0,this.brandList=[],this.filteredItems=[],this.taxAll=0,this.netTot=0,this.discTot=0,this.qrcodedata=null,console.log(this.status," jjjjj"),this.selectedAccount={id:"",ac_id:"",sub_name:"",sub_type:"",sub_code:"",sub_balance:"",store_id:"",cat_name:"",cat_id:"",phone:"",address:"",currentCustumerStatus:0},this.route.queryParams.subscribe(u=>{u&&u.payInvo&&(this.status="initial",this.payInvo=JSON.parse(u.payInvo),null==this.payInvo.cust_id?(this.radioVal=1,this.sub_nameNew=JSON.parse(u.sub_name)):this.selectedAccount.sub_name=JSON.parse(u.sub_name),this.user_info=JSON.parse(u.user_info),this.store_info=JSON.parse(u.store_info),this.itemList=JSON.parse(u.itemList),this.discountPerc=(+this.payInvo.discount/+this.payInvo.tot_pr*100).toFixed(2),this.prepareOffline(),this.getAppInfoCase2())}),this.printArr.push({payInvo:"",itemList:"",selectedAccount:"",sub_nameNew:"",userInfo:"",sub_balanse:0,balanceStatus:"",company:"",qrcodedata:""}),this.selectedItem={id:void 0,dateCreated:"",pay_ref:"",item_desc:"",item_name:"",item_unit:"",parcode:0,pay_price:0,perch_price:0,qty:0,tot:0,availQty:0,aliasEn:"",tax:0,discount:0}}checkPlatform(){this.platform.is("desktop")?this.device="desktop":this.platform.is("mobile")&&(this.device="mobile")}changeMode(){1==this.offline?(this.offline=!1,this.color="primary"):0==this.offline&&(this.offline=!0,this.color="dark"),this.storage.set("offline",this.offline).then(e=>{})}segmentChanged(e){this.filteredItems=this.items.filter(i=>i.brand===e.detail.value)}ionViewDidLeave(){}ionViewDidEnter(){setTimeout(()=>{},1e4)}ngOnInit(){this.checkPlatform(),"mobile"==this.device&&this.rout.navigate(["folder/sales-mob"]),this.prepareOffline(),"new"==this.status?this.getAppInfo():"initial"==this.status&&(this.getAppInfoCase2(),this.radioVal2=0),this.menuCtrl.close()}didDissmisNotif(){this.isOpenNotif=!1}bothItemAndAccount(e,i){return(0,I.mG)(this,void 0,void 0,function*(){yield this.getAllStockItemsWithouteCounts(),yield this.getSalesAccount(e,i)})}clear(e){e?this.selectedItem={id:void 0,dateCreated:"",pay_ref:this.payInvo.pay_ref,item_desc:"",item_name:"",item_unit:"",parcode:0,pay_price:0,perch_price:0,qty:0,tot:0,availQty:0,aliasEn:"",tax:0,discount:0}:this.searchTerm=""}getStockItems(){this.storage.get("year").then(e=>{e&&(this.year=e,0==this.offline?(this.loadingItems=!0,this.api.stockItems(1,this.year.id).subscribe(i=>{console.log(i),this.items=i.data,this.items.forEach(o=>{+o.tswiaQuantity>0?o.salesQuantity=+o.salesQuantity+ +o.tswiaQuantity:+o.tswiaQuantity<0&&(o.perchQuantity=+o.perchQuantity+Math.abs(+o.tswiaQuantity)),o.quantity=+o.perchQuantity+ +o.firstQuantity-+o.salesQuantity}),this.searchResult=this.items,this.loadingItems=!1,this.storage.set("itemsLocal",this.items).then(o=>{})},i=>{this.loadingItems=!1},()=>{this.loadingItems=!1})):(this.items=this.itemsLocal,this.items.forEach(i=>{+i.tswiaQuantity>0?i.salesQuantity=+i.salesQuantity+ +i.tswiaQuantity:+i.tswiaQuantity<0&&(i.perchQuantity=+i.perchQuantity+Math.abs(+i.tswiaQuantity)),i.quantity=+i.perchQuantity+ +i.firstQuantity-+i.salesQuantity}),this.searchResult=this.items))})}getBrands(){this.api.getBrands().subscribe(e=>{this.brandList=e.data,console.log(this.brandList),this.filteredItems=this.items.filter(s=>s.brand===this.brandList[0].brand)},e=>{},()=>{})}getAllStockItemsWithouteCounts(){this.storage.get("year").then(e=>{e&&(this.year=e,0==this.offline?(this.loadingItems=!0,this.api.getAllStockItemsWithouteCounts(1,this.year.id).subscribe(i=>{this.items=i.data,this.loadingItems=!1,this.storage.set("itemsLocal",this.items).then(o=>{})},i=>{this.loadingItems=!1},()=>{this.loadingItems=!1})):(this.items=this.itemsLocal,this.searchResult=this.items))})}afterSync(e){e.forEach(i=>{if(0==this.LogHistoryLocalArr.some(s=>s.logRef===i.logRef))this.LogHistoryLocalArr.push(i);else{let s=this.LogHistoryLocalArr.findIndex(o=>o.logRef===i.logRef);-1!=s&&(this.LogHistoryLocalArr[s]=i)}}),this.storage.set("LogHistoryLocal",this.LogHistoryLocalArr).then(i=>{})}presentAlertConfirm(e){return(0,I.mG)(this,void 0,void 0,function*(){let i="\u0647\u0644 \u062a\u0631\u064a\u062f \u0637\u0628\u0627\u0639\u0629 \u0641\u0627\u062a\u0648\u0631\u0629 \u061f ";e&&(i="\u0647\u0644 \u062a\u0631\u064a\u062f \u062d\u0630\u0641 \u0627\u0644\u0633\u062c\u0644 \u061f "),yield(yield this.alertController.create({cssClass:"my-custom-class",header:"\u062a\u0623\u0643\u064a\u062f!",mode:"ios",message:i,buttons:[{text:"\u0625\u0644\u063a\u0627\u0621",role:"cancel",cssClass:"secondary",id:"cancel-button",handler:o=>{this.prepareInvo()}},{text:"\u0645\u0648\u0627\u0641\u0642",id:"confirm-button",handler:()=>{e?this.deleteSalesInvoInit():this.presentModal(this.printArr,"sales")}}]})).present()})}Print(e){this.printMode=!0;var i=window.open("","PRINT","height=400,width=600");return i.document.write("<html><head>"),i.document.write('<style type="text/css">'),i.document.write(".sumsDiv{border-style: solid;border-color: gray;border-width: .5px;} .flr{ display: block; float: right; } .show{ } .hide{width:0px;height:0px} .w45 {width:45%} .w50 {width:50%} .w100 {width:100%} td, th {border: 1px solid #dddddd;text-align: center;padding: 8px;} tr:nth-child(even) {background-color: #dddddd;} .table{text-align: center;width: 100%; margin: 12px;}.ion-margin{ margin: 10px; } .ion-margin-top{ margin-top: 10px; } .rtl {  direction: rtl; } .ion-text-center{ text-align: center; } .ion-text-end{ text-align: left; } .ion-text-start{ text-align: right; }"),i.document.write("</style></head><body>"),i.document.write(document.getElementById(e).innerHTML),i.document.write("</body></html>"),i.document.close(),i.focus(),i.print(),i.close(),this.printMode=!1,!0}getOffliemode(){this.storage.get("offline").then(e=>{this.offline=e,1==this.offline?this.color="dark":0==this.offline?this.color="primary":this.SetOffliemode()})}SetOffliemode(){this.storage.set("offline",!1).then(e=>{this.offline=e,this.color="primary"})}getAppInfo(){this.getOffliemode(),this.storage.get("USER_INFO").then(e=>{e&&(this.user_info=e)}),this.storage.get("year").then(e=>{e&&(this.year=e)}),this.storage.get("company").then(e=>{this.company=e[0],console.log(this.company)}),this.storage.get("STORE_INFO").then(e=>{e&&(this.store_info=e,this.getItems(),this.prepareInvo())}),this.storage.get("initialInvoices").then(e=>{e&&(this.initialInvoices=e)}),this.getBrands()}getAppInfoCase2(){this.getOffliemode(),this.storage.get("USER_INFO").then(e=>{e&&(this.user_info=e)}),this.storage.get("year").then(e=>{e&&(this.year=e)}),this.storage.get("STORE_INFO").then(e=>{e&&(this.store_info=e)}),this.storage.get("LogHistoryLocal").then(e=>{e&&(this.LogHistoryLocalArr=e)}),this.storage.get("searchLang").then(e=>{e&&(this.searchLang=e)})}prepareOffline(){this.storage.get("salesLocal").then(e=>{e&&(this.salesLocal=e)}),this.storage.get("sales").then(e=>{e&&(this.sales=e)}),this.storage.get("itemsLocal").then(e=>{e&&(this.itemsLocal=e,this.items=this.itemsLocal)}),this.storage.get("sub_accountLocalSales").then(e=>{e&&(this.sub_accountLocalSales=e)}),this.storage.get("sub_accountSales").then(e=>{e&&(this.sub_accountSales=e,this.getSubBalance())})}newLogic(){return(0,I.mG)(this,void 0,void 0,function*(){yield this.getAppInfo(),yield this.prepareInvo()})}getItemLocalOff(){this.storage.get("itemsLocal").then(e=>{e&&(this.itemsLocal=e,this.items=this.itemsLocal,this.searchResult=this.items)})}getAccountOffline(){this.storage.get("sub_accountSales").then(e=>{e&&(this.sub_account=e,this.getSubBalance(),this.addSubaccountLocal())})}radioChange(e){}recalSubBalance(){this.sub_account.forEach(e=>{e.sub_balance=0;let i=+e.changeeTot+ +e.fromDebitTot,s=+e.purchChangeeTot+ +e.toCreditTot;0==this.radioVal&&this.selectedAccount.id==e.id&&(i=+i+ +this.payInvo.changee),i==s?(e.sub_balance=0,e.currentCustumerStatus=""):i>s?(e.sub_balance=(+i-+s).toFixed(2),e.currentCustumerStatus="debit",+this.selectedAccount.id==+e.id&&(this.selectedAccount.sub_balance=e.sub_balance,this.selectedAccount.currentCustumerStatus=e.currentCustumerStatus)):s>i&&(e.sub_balance=(+s-+i).toFixed(2),e.currentCustumerStatus="credit",+this.selectedAccount.id==+e.id&&(this.selectedAccount.sub_balance=e.sub_balance,this.selectedAccount.currentCustumerStatus=e.currentCustumerStatus))})}getSubBalance(){this.sub_account.forEach(e=>{e.sub_balance=0;let i=+e.changeeTot+ +e.fromDebitTot,s=+e.purchChangeeTot+ +e.toCreditTot;i==s?(e.sub_balance=0,this.currentCustumerStatus=""):i>s?(e.sub_balance=(+i-+s).toFixed(2),this.currentCustumerStatus="debit"):s>i&&(e.sub_balance=(+s-+i).toFixed(2),this.currentCustumerStatus="credit")})}radioChange2(e,i){"from"==i&&(1==e.target.value&&"initial"==this.status?(this.status="toFinal",this.payInvo.yearId=this.year.id,this.itemList.length>0&&this.itemList.forEach(s=>{s.yearId=this.year.id})):0==e.target.value&&"toFinal"==this.status&&(this.status="initial"))}prepareInvo(){this.selectedAccount={id:"",ac_id:"",sub_name:"",sub_type:"",sub_code:"",sub_balance:"",store_id:"",cat_id:"",cat_name:"",phone:"",address:"",currentCustumerStatus:0},this.sub_nameNew="",this.radioVal=0,this.radioVal2=0,this.payInvo={pay_id:void 0,pay_ref:0,store_id:"",tot_pr:0,pay:0,pay_date:"",pay_time:"",user_id:"",cust_id:null,pay_method:"",discount:0,changee:0,sub_name:"",payComment:"",nextPay:null,yearId:this.year.id,companyId:this.company.id,recived:0,taxTot:0,backed:0,discountTot:0},this.discountPerc=0;let e=new Date;this.payInvo.pay_date=this.datePipe.transform(e,"yyyy-MM-dd"),this.payInvo.pay_time=this.datePipe.transform(e,"HH:mm:ss"),this.payInvo.pay_method="card",this.generateRandom(),this.payInvo.store_id=this.store_info.id,this.payInvo.user_id=this.user_info.id,this.payInvo.yearId=this.year.id,this.itemList=[],console.log("payInvo prepare",this.payInvo)}isFocused(e){}getItems(){0==this.offline?this.api.getItems().subscribe(e=>{this.items=e.data,this.items.forEach(s=>{this.sanitizer.bypassSecurityTrustResourceUrl(s.imgUrl)}),console.log(this.items)},e=>{}):this.items=this.itemsLocal}getSalesAccount(e,i){0==this.offline?this.api.getSalesAccounts(this.store_info.id,this.year.id).subscribe(s=>{this.sub_account=s.data,this.getSubBalance(),this.addSubaccountLocal(),"sync both"==e&&(this.storage.set("sub_accountSales",this.sub_account).then(r=>{}),this.afterSync(i))},s=>{}):this.MixSubaccountSalesOffline()}addSubaccountLocal(){if(this.sub_account){if(this.sub_accountLocalSales)for(let e=0;e<this.sub_accountLocalSales.length;e++)this.sub_account.push(this.sub_accountLocalSales[e])}else this.sub_accountLocalSales&&(this.sub_account=this.sub_accountLocalSales)}MixSubaccountSalesOffline(){if(this.sub_account=[],this.sub_accountLocalSales)for(let e=0;e<this.sub_accountLocalSales.length;e++)this.sub_account.push(this.sub_accountLocalSales[e]);if(this.sub_accountSales)for(let e=0;e<this.sub_accountSales.length;e++)this.sub_account.push(this.sub_accountSales[e])}generateRandom(){let e=new Date,i=e.getMonth().toString()+e.getDay().toString()+e.getHours().toString()+e.getMinutes().toString()+e.getSeconds().toString()+e.getMilliseconds().toString();this.payInvo.pay_ref=this.store_info.store_ref+i}pickAccount(e){let i=this.sub_account.filter(s=>s.sub_name==e.target.value);i.length>0?(this.selectedAccount={id:i[0].id,ac_id:i[0].ac_id,sub_name:i[0].sub_name,sub_type:i[0].sub_type,sub_code:i[0].sub_code,store_id:i[0].store_id,sub_balance:i[0].sub_balance,cat_id:i[0].cat_id,cat_name:i[0].cat_name,phone:i[0].phone,address:i[0].address,currentCustumerStatus:i[0].currentCustumerStatus},this.payInvo.cust_id=this.selectedAccount.id,this.payInvo.sub_name=this.selectedAccount.sub_name):(this.presentToast("\u062e\u0637\u0623 \u0641\u064a \u0627\u0633\u0645 \u0627\u0644\u062d\u0633\u0627\u0628 ","danger"),this.selectedItem.item_name="")}selectFromPop(e){this.selectedItem={id:e.id,dateCreated:e.dateCreated,pay_ref:this.payInvo.pay_ref,item_desc:e.item_desc,item_name:e.item_name,item_unit:e.item_unit,parcode:e.parcode,pay_price:e.pay_price,perch_price:e.perch_price,qty:"",tot:e.pay_price,availQty:e.quantity,aliasEn:e.aliasEn,tax:e.tax,discount:0},this.searchTerm=e.item_name}getItemPaysByItemId(){this.api.getItemQtyPaysByItemId(this.store_info.id,this.selectedItem.id,this.year.id).subscribe(e=>{console.log("getItemPaysByItemId",e),"No record Found"!=e.message&&(this.payTotQty=e.data[0].salesQuantity),this.getQtyPurchByItemId()},e=>{this.presentToast("1\u062e\u0637\u0627 \u0641\u064a \u0627\u0644\u0625\u062a\u0635\u0627\u0644 \u062d\u0627\u0648\u0644 \u0645\u0631\u0629 \u0627\u062e\u0631\u064a","danger")},()=>{})}getQtyPurchByItemId(){this.api.getQtyPurchByItemId(this.store_info.id,this.selectedItem.id,this.year.id).subscribe(e=>{let i=e;"No record Found"!=i.message&&(this.perchTotQty=i.data[0].perchQuantity,this.firstQty=i.data[0].firstQuantity),this.getQtyTswiaByItemId()},e=>{this.presentToast("  \u062e\u0637\u0627 \u0641\u064a \u0627\u0644\u0625\u062a\u0635\u0627\u0644 \u062d\u0627\u0648\u0644 \u0645\u0631\u0629 \u0627\u062e\u0631\u064a","danger")},()=>{})}getQtyTswiaByItemId(){this.api.getQtyTswiaByItemId(this.store_info.id,this.selectedItem.id,this.year.id).subscribe(e=>{console.log("getQtyTswiaByItemId",e);let i=e;"No record Found"!=i.message&&(this.availQty=i.data[0].availQty,this.qtyReal=i.data[0].qtyReal),this.getQtyTotalItemId()},e=>{this.presentToast("  \u062e\u0637\u0627 \u0641\u064a \u0627\u0644\u0625\u062a\u0635\u0627\u0644 \u062d\u0627\u0648\u0644 \u0645\u0631\u0629 \u0627\u062e\u0631\u064a","danger")},()=>{})}getQtyTotalItemId(){+this.availQty-+this.qtyReal<0?this.perchTotQty=+this.perchTotQty+Math.abs(+this.availQty-+this.qtyReal):+this.availQty-+this.qtyReal>0&&(this.payTotQty=+this.availQty-+this.qtyReal+ +this.payTotQty),this.availQty=+this.perchTotQty-+this.payTotQty,console.log(this.payTotQty,this.payTotQty)}pickDetail(e){let i=[];i=this.items.filter(1==this.searchLang?s=>s.item_desc==e.target.value:s=>s.item_name==e.target.value),i.length>0?this.selectedItem={id:i[0].id,dateCreated:i[0].dateCreated,pay_ref:this.payInvo.pay_ref,item_desc:i[0].item_desc,item_name:i[0].item_name,item_unit:i[0].item_unit,parcode:i[0].parcode,pay_price:i[0].pay_price,perch_price:i[0].perch_price,qty:"",tot:i[0].pay_price,availQty:i[0].quantity,aliasEn:i[0].aliasEn,tax:i[0].tax,discount:i[0].disc}:(this.presentToast("\u062e\u0637\u0623 \u0641\u064a \u0627\u0633\u0645 \u0627\u0644\u0635\u0646\u0641 ","danger"),this.selectedItem.item_name="",this.selectedItem.item_desc="")}qtyhange(e){this.selectedItem.tot=(this.selectedItem.qty*+this.selectedItem.pay_price).toFixed(2);let i=[];this.itemList.length>0?(i=this.itemList.filter(s=>s.item_name==this.selectedItem.item_name),i.length>0?+this.selectedItem.qty+ +i[0].quantity>+this.selectedItem.availQty&&this.presentToast("\u0627\u0644\u0635\u0646\u0641 \u0645\u0648\u062c\u0648\u062f \u0628\u0627\u0644\u0642\u0627\u0626\u0645\u0629 , \u0645\u062c\u0645\u0648\u0639 \u0627\u0644\u0643\u0645\u064a\u0629 \u0627\u0644\u062c\u062f\u064a\u062f \u0627\u0643\u0628\u0631 \u0645\u0646 \u0627\u0644\u0645\u062a\u0648\u0641\u0631 \u0641\u064a \u0627\u0644\u0645\u062e\u0632\u0646","warning"):+this.selectedItem.qty>+this.selectedItem.availQty&&this.presentToast("\u0627\u0644\u0643\u0645\u064a\u0629 \u0641\u064a \u0627\u0644\u0645\u062e\u0632\u0646 \u063a\u064a\u0631 \u0643\u0627\u0641\u064a\u0629","warning")):+this.selectedItem.qty>+this.selectedItem.availQty&&this.presentToast("\u0627\u0644\u0643\u0645\u064a\u0629 \u0641\u064a \u0627\u0644\u0645\u062e\u0632\u0646 \u063a\u064a\u0631 \u0643\u0627\u0641\u064a\u0629","warning")}pricehange(e){let i=+this.selectedItem.discount/100*(+this.selectedItem.pay_price*this.selectedItem.qty);this.selectedItem.tot=(this.selectedItem.qty*(+this.selectedItem.pay_price*this.selectedItem.qty-i+ +this.selectedItem.tax/100*(+this.selectedItem.pay_price*this.selectedItem.qty-i))).toFixed(2)}getTotal(){let e=this.itemList.reduce((i,s)=>i+ +s.quantity*+s.pay_price,0);this.payInvo.taxTot=this.itemList.reduce((i,s)=>i+ +s.tax,0),this.payInvo.discountTot=this.itemList.reduce((i,s)=>i+ +s.discount,0),this.payInvo.discountTot=this.payInvo.discountTot.toFixed(2),console.log("sum",e),this.payInvo.taxTot=this.payInvo.taxTot.toFixed(2),this.payInvo.tot_pr=+e-+this.payInvo.discount,this.taxAll=(+this.payInvo.tot_pr-this.payInvo.discountTot+ +this.payInvo.taxTot).toFixed(2),this.payInvo.pay=+this.taxAll,this.payInvo.changee=+this.taxAll-+this.payInvo.pay,this.payInvo.tot_pr=this.payInvo.tot_pr.toFixed(2),this.payInvo.changee=this.payInvo.changee.toFixed(2)}payChange(e){this.payInvo.recived=e.target.value,this.payInvo.backed=+this.taxAll-e.target.value,this.payInvo.changee=+this.taxAll-e.target.value}discountChange(e){this.getTotal()}discountPerChange(e){this.payInvo.discount=(+this.payInvo.tot_pr*+this.discountPerc/100).toFixed(2),this.payInvo.changee=+(this.payInvo.tot_pr-this.payInvo.discount)-this.payInvo.pay}deleteItem(e){this.itemList.splice(e,1),this.payInvo.pay=0,this.discountPerc=0,this.payInvo.discount=0,this.netTot=0,this.taxAll=0,this.getTotal()}presentToast(e,i){return(0,I.mG)(this,void 0,void 0,function*(){(yield this.toast.create({message:e,duration:2e3,color:i,cssClass:"cust_Toast",mode:"ios",position:"top"})).present()})}refresh(e){"account"==e?this.getSalesAccount():this.getAllStockItemsWithouteCounts()}addTolist(){if(""==this.selectedItem.item_name||""==this.selectedItem.id||0==+this.selectedItem.qty)this.presentToast("\u0627\u0644\u0631\u062c\u0627\u0621 \u0627\u062e\u062a\u064a\u0627\u0631 \u0627\u0644\u0635\u0646\u0641 \u0648\u062a\u062d\u062f\u064a\u062f \u0627\u0644\u0643\u0645\u064a\u0629","danger");else{let e=[];if(this.itemList.length>0&&(e=this.itemList.filter(i=>i.item_name==this.selectedItem.item_name&&i.pay_price==this.selectedItem.pay_price)),0==e.length){let i=new Date,s=this.datePipe.transform(i,"dd-MM-YYYY");this.itemList.push({id:"NULL",pay_ref:this.selectedItem.pay_ref,item_name:this.selectedItem.item_name,pay_price:this.selectedItem.pay_price,quantity:+this.selectedItem.qty,tot:this.selectedItem.tot,store_id:+this.store_info.id,yearId:+this.year.id,item_id:+this.selectedItem.id,dateCreated:s,perch_price:this.selectedItem.perch_price,tax:this.selectedItem.tax,discount:this.selectedItem.discount})}else{this.selectedItem.qty=+e[0].quantity+ +this.selectedItem.qty;let i=this.itemList.map(s=>s.item_name).indexOf(this.selectedItem.item_name);this.itemList[i].quantity=+this.selectedItem.qty,this.itemList[i].tot=(this.selectedItem.qty*+this.selectedItem.pay_price).toFixed(2)}this.selectedItem={id:void 0,dateCreated:"",pay_ref:this.payInvo.pay_ref,item_desc:"",item_name:"",item_unit:"",parcode:0,pay_price:0,perch_price:0,qty:0,tot:0,availQty:0,aliasEn:"",tax:0,discount:0},this.discountPerc=0,this.payInvo.discount=0,this.getTotal()}}addTolistClick(e){this.selectedItem=e,console.log(e),this.selectedItem={id:e.id,dateCreated:"",pay_ref:this.payInvo.pay_ref,item_desc:e.item_desc,item_name:e.item_name,item_unit:e.item_unit,parcode:e.parcode,pay_price:e.pay_price,perch_price:e.item_name,qty:1,tot:e.tot,availQty:0,aliasEn:+e.aliasEn,tax:e.tax,discount:e.discount};let i=[];if(this.itemList.length>0&&(i=this.itemList.filter(s=>s.item_name==this.selectedItem.item_name&&s.pay_price==this.selectedItem.pay_price)),0==i.length){let s=(+this.selectedItem.discount/100*+this.selectedItem.pay_price).toFixed(2),o=(+this.selectedItem.tax/100*(+this.selectedItem.pay_price-+s)).toFixed(2),r=+this.selectedItem.pay_price-+s+ +o,l=new Date,d=this.datePipe.transform(l,"dd-MM-YYYY");this.selectedItem.qty=1,this.itemList.push({id:"NULL",pay_ref:this.selectedItem.pay_ref,item_name:this.selectedItem.item_name,pay_price:this.selectedItem.pay_price,quantity:+this.selectedItem.qty,tot:r.toFixed(2),store_id:+this.store_info.id,yearId:+this.year.id,item_id:+this.selectedItem.id,dateCreated:d,perch_price:this.selectedItem.perch_price,tax:o,discount:+s})}else{this.selectedItem.qty=1,this.selectedItem.qty=+i[0].quantity+ +this.selectedItem.qty;let s=this.itemList.map(d=>d.item_name).indexOf(this.selectedItem.item_name);this.itemList[s].quantity=+this.selectedItem.qty;let o=(+this.selectedItem.pay_price*+this.selectedItem.qty*+this.selectedItem.discount/100).toFixed(2),r=((+this.selectedItem.pay_price*+this.selectedItem.qty-+o)*this.selectedItem.tax/100).toFixed(2),l=(+this.selectedItem.pay_price*+this.selectedItem.qty-+o+ +r).toFixed(2);this.itemList[s].discount=o,this.itemList[s].tot=l,this.itemList[s].tax=r}this.selectedItem={id:void 0,dateCreated:"",pay_ref:this.payInvo.pay_ref,item_desc:"",item_name:"",item_unit:"",parcode:0,pay_price:0,perch_price:0,qty:0,tot:0,availQty:0,aliasEn:"",tax:0,discount:0},this.discountPerc=0,this.payInvo.discount=0,this.getTotal()}qtyClick(e){this.showMe=e,this.cellIndex=e}presentPopoverQtyPop(e,i){console.log("preent me",i),this.showMe=i,this.cellIndex=i,this.showNotif=!1,this.popoverNotif.event=e,this.isOpenNotif=!0}hideMe(e){this.showMe=null}didDissmisQtPop(){this.isOpenNotif=!1,this.showMe=null}editCell(e){+this.itemList[e].quantity>0&&+this.itemList[e].pay_price>0?(this.itemList[e].tot=+this.itemList[e].quantity*+this.itemList[e].pay_price,this.discountPerc=0,this.payInvo.discount=0,this.hideMe(e),this.getTotal()):this.presentToast("\u062e\u0637\u0623 \u0641\u064a \u0627\u0644\u0625\u062f\u062e\u0627\u0644 ","danger")}editCellPop(e,i){if(+this.itemList[e].quantity>0&&+this.itemList[e].pay_price>0){i&&(this.itemList[e].quantity=i);let s=[];s=this.items.filter(d=>d.id==+this.itemList[e].item_id),console.log(s[0]);let o=(+s[0].pay_price*+this.itemList[e].quantity*s[0].discount/100).toFixed(2),r=((s[0].pay_price*+this.itemList[e].quantity-+o)*s[0].tax/100).toFixed(2),l=(this.itemList[e].pay_price*this.itemList[e].quantity-+o+ +r).toFixed(2);this.itemList[e].discount=o,this.itemList[e].tot=l,this.itemList[e].tax=r,this.discountPerc=0,this.payInvo.discount=0,this.didDissmisQtPop(),this.getTotal()}else this.presentToast("\u062e\u0637\u0623 \u0641\u064a \u0627\u0644\u0625\u062f\u062e\u0627\u0644 ","danger")}validate(){return this.sub_account&&this.sub_account.filter(i=>i.sub_name==this.sub_nameNew),0==this.itemList.length||""==this.payInvo.pay_ref?(this.presentToast("\u0627\u0644\u0631\u062c\u0627\u0621 \u0627\u062f\u062e\u0627\u0644 \u0627\u0635\u0646\u0627\u0641 \u0627\u0644\u064a \u0627\u0644\u0642\u0627\u0626\u0645\u0629","danger"),!1):""==this.payInvo.pay_date||null==this.payInvo.pay_date?(this.presentToast("\u0627\u0644\u0631\u062c\u0627\u0621 \u062a\u062d\u062f\u064a\u062f \u0627\u0644\u062a\u0627\u0631\u064a\u062e ","danger"),!1):!(this.payInvo.changee<0&&(this.presentToast("\u0627\u0644\u0631\u062c\u0627\u0621 \u0645\u0631\u0627\u062c\u0639\u0629 \u0627\u0644\u0645\u0628\u0644\u063a \u0627\u0644\u0645\u0633\u062a\u0644\u0645 \u0648\u0627\u0644\u062e\u0635\u0645  ","danger"),1))}saveIntial(){1==this.radioVal&&(this.payInvo.sub_name=this.sub_nameNew,this.payInvo.cust_id=null),this.initialInvoices.length>0&&(this.initialInvoices=this.initialInvoices.filter(e=>e.payInvo.pay_ref!=this.payInvo.pay_ref)),this.initialInvoices.push({payInvo:this.payInvo,itemList:this.itemList}),this.storage.set("initialInvoices",this.initialInvoices).then(e=>{this.printArr=[],this.recalSubBalance(),this.printArr.push({payInvo:this.payInvo,itemList:this.itemList,selectedAccount:this.selectedAccount,sub_nameNew:this.sub_nameNew,user_name:this.user_info.full_name,sub_balanse:this.selectedAccount.sub_balance,balanceStatus:this.selectedAccount.currentCustumerStatus,company:this.company,qrcodedata:this.qrcodedata}),this.presentAlertConfirm(),this.presentToast("\u062a\u0645 \u0627\u0644\u062d\u0641\u0638 \u0628\u0646\u062c\u0627\u062d","success"),this.prepareInvo(),this.status="new"})}saveInvoInit(){this.api.saveSalesInvoInit(this.payInvo).subscribe(e=>{this.saveitemListinit()},e=>{this.presentToast("\u0644\u0645 \u064a\u062a\u0645 \u062d\u0641\u0638 \u0627\u0644\u0628\u064a\u0627\u0646\u0627\u062a , \u062e\u0637\u0627 \u0641\u064a \u0627\u0644\u0625\u062a\u0635\u0627\u0644 \u062d\u0627\u0648\u0644 \u0645\u0631\u0629 \u0627\u062e\u0631\u064a","danger")})}deleteInitial(){this.initialInvoices.length>0&&(this.initialInvoices=this.initialInvoices.filter(e=>e.payInvo.pay_ref!=this.payInvo.pay_ref)),this.storage.set("initialInvoices",this.initialInvoices).then(e=>{this.presentToast("\u062a\u0645 \u0627\u0644\u062d\u0630\u0641 \u0628\u0646\u062c\u0627\u062d","success"),this.status="new",this.prepareInvo()})}deleteSalesInvoInit(){"toFinal"!=this.status&&this.presentLoadingWithOptions("\u062c\u0627\u0631\u064a \u062d\u0630\u0641 \u0627\u0644\u0628\u064a\u0627\u0646\u0627\u062a ..."),this.api.deleteSalesInvoInit(this.payInvo.pay_id).subscribe(e=>{"Post Not Deleted"!=e.message?this.deleteSalesitemListInit():this.presentToast("\u0644\u0645 \u064a\u062a\u0645 \u062d\u0630\u0641 \u0627\u0644\u0628\u064a\u0627\u0646\u0627\u062a , \u062e\u0637\u0627 \u0641\u064a \u0627\u0644\u0625\u062a\u0635\u0627\u0644 \u062d\u0627\u0648\u0644 \u0645\u0631\u0629 \u0627\u062e\u0631\u064a","danger")},e=>{this.presentToast("\u0644\u0645 \u064a\u062a\u0645 \u062d\u0630\u0641 \u0627\u0644\u0628\u064a\u0627\u0646\u0627\u062a , \u062e\u0637\u0627 \u0641\u064a \u0627\u0644\u0625\u062a\u0635\u0627\u0644 \u062d\u0627\u0648\u0644 \u0645\u0631\u0629 \u0627\u062e\u0631\u064a","danger")})}deleteSalesitemListInit(){this.api.deleteSalesitemListInit(this.payInvo.pay_ref).subscribe(e=>{"Post Not Deleted"!=e.message?"toFinal"!=this.status&&(this.presentToast("\u062a\u0645 \u0627\u0644\u062d\u0630\u0641 \u0628\u0646\u062c\u0627\u062d","success"),this.prepareInvo()):this.presentToast("\u0644\u0645 \u064a\u062a\u0645 \u062d\u0630\u0641 \u0627\u0644\u0628\u064a\u0627\u0646\u0627\u062a , \u062e\u0637\u0627 \u0641\u064a \u0627\u0644\u0625\u062a\u0635\u0627\u0644 \u062d\u0627\u0648\u0644 \u0645\u0631\u0629 \u0627\u062e\u0631\u064a","danger")},e=>{this.presentToast("\u0644\u0645 \u064a\u062a\u0645 \u062d\u0630\u0641 \u0627\u0644\u0628\u064a\u0627\u0646\u0627\u062a , \u062e\u0637\u0627 \u0641\u064a \u0627\u0644\u0625\u062a\u0635\u0627\u0644 \u062d\u0627\u0648\u0644 \u0645\u0631\u0629 \u0627\u062e\u0631\u064a","danger")},()=>{this.loadingController.dismiss()})}save(){let e=this.payInvo.pay_date;this.payInvo.sub_name=this.selectedAccount.sub_name,this.payInvo.pay_date=this.datePipe.transform(e,"yyyy-MM-dd"),1==this.validate()&&(this.presentLoadingWithOptions("\u062c\u0627\u0631\u064a \u062d\u0641\u0638 \u0627\u0644\u0628\u064a\u0627\u0646\u0627\u062a ..."),console.log(this.payInvo),this.prepareQrcode2(),this.saveInvo())}saveLogHistory(){let e,i,s;this.logHistoryArr.length>1?(s=this.logHistoryArr[1],i=this.logHistoryArr[0],e="new account"):(s=this.logHistoryArr[0],e=void 0),this.api.saveLogHistoryMultiSales(s,i,e).subscribe(o=>{"Post Not Created"!=o.message?(this.logHistoryArr=[],this.presentAlertConfirm(),this.presentToast("\u062a\u0645 \u0627\u0644\u062d\u0641\u0638 \u0628\u0646\u062c\u0627\u062d","success")):this.presentToast("\u0644\u0645 \u064a\u062a\u0645 \u062d\u0641\u0638 \u0627\u0644\u0628\u064a\u0627\u0646\u0627\u062a , \u062e\u0637\u0627 \u0641\u064a \u0627\u0644\u0625\u062a\u0635\u0627\u0644 \u062d\u0627\u0648\u0644 \u0645\u0631\u0629 \u0627\u062e\u0631\u064a","danger")},o=>{this.presentToast("\u0644\u0645 \u064a\u062a\u0645 \u062d\u0641\u0638 \u0627\u0644\u0628\u064a\u0627\u0646\u0627\u062a , \u062e\u0637\u0627 \u0641\u064a \u0627\u0644\u0625\u062a\u0635\u0627\u0644 \u062d\u0627\u0648\u0644 \u0645\u0631\u0629 \u0627\u062e\u0631\u064a","danger")})}performSync(){return(0,I.mG)(this,void 0,void 0,function*(){yield this.saveLogHistory(),yield this.getAllStockItemsWithouteCounts()})}back(){this._location.back()}updateInitInvo(){this.api.updateInitSalesInvo(this.payInvo).subscribe(e=>{this.deleteSalesitemListInit4update()},e=>{this.presentToast("\u0644\u0645 \u064a\u062a\u0645 \u062d\u0641\u0638 \u0627\u0644\u0628\u064a\u0627\u0646\u0627\u062a , \u062e\u0637\u0627 \u0641\u064a \u0627\u0644\u0625\u062a\u0635\u0627\u0644 \u062d\u0627\u0648\u0644 \u0645\u0631\u0629 \u0627\u062e\u0631\u064a","danger").then(()=>{this.loadingController.dismiss()})})}deleteSalesitemListInit4update(){this.api.deleteSalesitemListInit(this.payInvo.pay_ref).subscribe(e=>{"Post Not Deleted"!=e.message?this.saveitemListinit():this.presentToast("\u0644\u0645 \u064a\u062a\u0645 \u062d\u0630\u0641 \u0627\u0644\u0628\u064a\u0627\u0646\u0627\u062a , \u062e\u0637\u0627 \u0641\u064a \u0627\u0644\u0625\u062a\u0635\u0627\u0644 \u062d\u0627\u0648\u0644 \u0645\u0631\u0629 \u0627\u062e\u0631\u064a","danger").then(()=>{this.loadingController.dismiss()})},e=>{this.presentToast("\u0644\u0645 \u064a\u062a\u0645 \u062d\u0630\u0641 \u0627\u0644\u0628\u064a\u0627\u0646\u0627\u062a , \u062e\u0637\u0627 \u0641\u064a \u0627\u0644\u0625\u062a\u0635\u0627\u0644 \u062d\u0627\u0648\u0644 \u0645\u0631\u0629 \u0627\u062e\u0631\u064a","danger").then(()=>{this.loadingController.dismiss()})})}preparenewaccount(){this.selectedAccount.sub_name.length>0&&null==this.selectedAccount.id||(this.selectedAccount.sub_name=this.sub_nameNew,this.payInvo.sub_name=this.selectedAccount.sub_name),this.selectedAccount.id=null,this.selectedAccount.ac_id=1,this.selectedAccount.sub_type="debit",this.selectedAccount.sub_code=null,this.selectedAccount.sub_balance="0",this.selectedAccount.cat_id=1,this.selectedAccount.cat_name="\u0627\u0644\u0639\u0645\u0644\u0627\u0621",this.selectedAccount.store_id=this.store_info.id}saveSubAccount(){this.preparenewaccount(),this.api.saveSubAccount(this.selectedAccount).subscribe(e=>{"Post Not Created"!=e.message?(this.payInvo.cust_id=e.message,0==this.radioVal&&null==this.selectedAccount.id&&0==this.offline&&(this.sub_accountLocalSales=this.sub_accountLocalSales.filter(i=>i.sub_name!=this.selectedAccount.sub_name),this.storage.set("sub_accountLocalSales",this.sub_accountLocalSales).then(i=>{this.selectedAccount.id=this.payInvo.cust_id,this.sub_accountSales.push(this.selectedAccount),this.storage.set("sub_accountSales",this.sub_accountSales).then(s=>{})})),this.selectedAccount.id=e.message,this.logHistoryArr.push({id:null,logRef:this.generateRandom2("insert customer"),userId:this.user_info.id,typee:"insert customer",datee:"",logStatus:0,logToken:JSON.stringify(this.selectedAccount),yearId:this.year.id,store_id:this.store_info.id}),this.saveInvo()):this.presentToast("\u0644\u0645 \u064a\u062a\u0645 \u0627\u0646\u0634\u0627\u0621 \u062d\u0633\u0627\u0628 \u0644\u0644\u0639\u0645\u064a\u0644 , \u062e\u0637\u0627 \u0641\u064a \u0627\u0644\u0625\u062a\u0635\u0627\u0644 \u062d\u0627\u0648\u0644 \u0645\u0631\u0629 \u0627\u062e\u0631\u064a","danger")},e=>{this.presentToast("\u0644\u0645 \u064a\u062a\u0645 \u0627\u0646\u0634\u0627\u0621 \u062d\u0633\u0627\u0628 \u0644\u0644\u0639\u0645\u064a\u0644 , \u062e\u0637\u0627 \u0641\u064a \u0627\u0644\u0625\u062a\u0635\u0627\u0644 \u062d\u0627\u0648\u0644 \u0645\u0631\u0629 \u0627\u062e\u0631\u064a","danger")},()=>{this.loadingController.dismiss()})}saveSubAccountInit(){this.preparenewaccount(),this.api.saveSubAccount(this.selectedAccount).subscribe(e=>{"Post Not Created"!=e.message?(this.payInvo.cust_id=e.message,this.saveInvoInit()):this.presentToast("\u0644\u0645 \u064a\u062a\u0645 \u0627\u0646\u0634\u0627\u0621 \u062d\u0633\u0627\u0628 \u0644\u0644\u0639\u0645\u064a\u0644 , \u062e\u0637\u0627 \u0641\u064a \u0627\u0644\u0625\u062a\u0635\u0627\u0644 \u062d\u0627\u0648\u0644 \u0645\u0631\u0629 \u0627\u062e\u0631\u064a","danger")},e=>{this.presentToast("\u0644\u0645 \u064a\u062a\u0645 \u0627\u0646\u0634\u0627\u0621 \u062d\u0633\u0627\u0628 \u0644\u0644\u0639\u0645\u064a\u0644 , \u062e\u0637\u0627 \u0641\u064a \u0627\u0644\u0625\u062a\u0635\u0627\u0644 \u062d\u0627\u0648\u0644 \u0645\u0631\u0629 \u0627\u062e\u0631\u064a","danger")},()=>{this.loadingController.dismiss()})}saveSubAccountlocal(){this.preparenewaccount(),this.sub_account||(this.sub_account=[]),this.sub_account.push(this.selectedAccount),this.sub_accountLocalSales.push(this.selectedAccount),this.storage.set("sub_accountLocalSales",this.sub_accountLocalSales).then(e=>{this.saveInvoLocal()})}saveInvo(){console.log("saveInvo"),this.api.saveSalesInvo(this.payInvo).subscribe(e=>{console.log("save",e),"Post Not Created"!=e.message&&(this.payInvo.pay_id=e.message,this.saveitemList())},e=>{this.presentToast("\u0644\u0645 \u064a\u062a\u0645 \u062d\u0641\u0638 \u0627\u0644\u0628\u064a\u0627\u0646\u0627\u062a , \u062e\u0637\u0627 \u0641\u064a \u0627\u0644\u0625\u062a\u0635\u0627\u0644 \u062d\u0627\u0648\u0644 \u0645\u0631\u0629 \u0627\u062e\u0631\u064a","danger")})}saveInvoLocal(){console.log("saveInvoLocal"),this.salesLocal.push({payInvo:this.payInvo,itemList:this.itemList}),this.storage.set("salesLocal",this.salesLocal).then(e=>{this.printArr=[],this.recalSubBalance(),this.printArr.push({payInvo:this.payInvo,itemList:this.itemList,selectedAccount:this.selectedAccount,sub_nameNew:this.sub_nameNew,user_name:this.user_info.full_name,sub_balanse:this.selectedAccount.sub_balance,balanceStatus:this.selectedAccount.currentCustumerStatus,company:this.company,qrcodedata:this.qrcodedata}),this.presentAlertConfirm(),this.presentToast("\u062a\u0645 \u0627\u0644\u062d\u0641\u0638 \u0628\u0646\u062c\u0627\u062d","success"),this.initialInvoices.length>0&&(this.initialInvoices=this.initialInvoices.filter(i=>i.payInvo.pay_ref!=this.payInvo.pay_ref),this.storage.set("initialInvoices",this.initialInvoices).then(i=>{}))})}saveitemListinit(){this.api.saveSalesitemListInit(this.itemList).subscribe(e=>{this.recalSubBalance(),this.printArr=[],this.recalSubBalance(),this.printArr.push({payInvo:this.payInvo,itemList:this.itemList,selectedAccount:this.selectedAccount,sub_nameNew:this.sub_nameNew,user_name:this.user_info.full_name,sub_balanse:this.selectedAccount.sub_balance,balanceStatus:this.selectedAccount.currentCustumerStatus,company:this.company,qrcodedata:this.qrcodedata}),this.presentAlertConfirm(),this.presentToast("\u062a\u0645 \u0627\u0644\u062d\u0641\u0638 \u0628\u0646\u062c\u0627\u062d","success"),this.prepareInvo(),this.status="new"},e=>{this.presentToast("\u0644\u0645 \u064a\u062a\u0645 \u062d\u0641\u0638 \u0627\u0644\u0628\u064a\u0627\u0646\u0627\u062a , \u062e\u0637\u0627 \u0641\u064a \u0627\u0644\u0625\u062a\u0635\u0627\u0644 \u062d\u0627\u0648\u0644 \u0645\u0631\u0629 \u0627\u062e\u0631\u064a","danger")},()=>{this.loadingController.dismiss()})}saveitemList(){return(0,I.mG)(this,void 0,void 0,function*(){this.api.saveSalesitemList(this.itemList).subscribe(e=>{this.printArr=[],this.printArr.push({payInvo:this.payInvo,itemList:this.itemList,selectedAccount:this.selectedAccount,sub_nameNew:this.sub_nameNew,user_name:this.user_info.full_name,sub_balanse:this.selectedAccount.sub_balance,balanceStatus:this.selectedAccount.currentCustumerStatus,company:this.company,qrcodedata:this.qrcodedata,qrCodeDataUrl:""}),this.sales=this.sales.filter(s=>s.payInvo.pay_ref!=this.payInvo.pay_ref),[].push({payInvo:this.payInvo,itemList:this.itemList}),this.presentAlertConfirm(),this.presentToast("\u062a\u0645 \u0627\u0644\u062d\u0641\u0638 \u0628\u0646\u062c\u0627\u062d","success"),this.prepareInvo()},e=>{this.presentToast("\u0644\u0645 \u064a\u062a\u0645 \u062d\u0641\u0638 \u0627\u0644\u0628\u064a\u0627\u0646\u0627\u062a , \u062e\u0637\u0627 \u0641\u064a \u0627\u0644\u0625\u062a\u0635\u0627\u0644 \u062d\u0627\u0648\u0644 \u0645\u0631\u0629 \u0627\u062e\u0631\u064a","danger")},()=>{this.loadingController.dismiss()})})}generateRandom2(e){let i=new Date,s=i.getMonth().toString()+i.getDay().toString()+i.getHours().toString()+i.getMinutes().toString()+i.getSeconds().toString()+i.getMilliseconds().toString()+e;return this.store_info.store_ref+s}deleteInitInvo(){}prepareQrcode(){console.log("prepareQrcode");const s=(0,v.p6)(this.payInvo.pay_date,"yyyy-MM-dd","en-US")+"T"+this.payInvo.pay_time+"Z";console.log(s);const o=this.stringToHex(this.company.engName);let l=this.toHex(this.company.engName.length);1==l.length&&(l="0"+l);const d="01"+l+o;console.log("company",o,l,d),console.log("hex",this.toHex(this.company.engName.length));const b=this.stringToHex(this.company.vatNo.toString());let y=this.toHex(this.company.vatNo.toString().length);1==y.length&&(y="0"+y);const x="02"+y+b;console.log("companyVat",b,y,x);const g=this.stringToHex(s.toString());let f=this.toHex(s.toString().length);1==f.length&&(f="0"+f);const _="03"+f+g;console.log("dateTime",g,f,_);const T=this.stringToHex((+this.taxAll).toString());let p=this.toHex((+this.taxAll).toString().length);1==p.length&&(p="0"+p);const Z="04"+p+T;console.log("total",T,p,Z),console.log("tot",this.taxAll.toFixed(2).toString()),console.log("totax",this.payInvo.taxTot);const C=this.stringToHex(this.payInvo.taxTot.toString());let S=this.toHex(this.payInvo.taxTot.toString().length);1==S.length&&(S="0"+S);const w="05"+S+C;console.log("tax",C,S,w),console.log("tottax",this.payInvo.taxTot);const nt=btoa(d+x+_+Z+w);this.qrcodedata=nt,this.printArr[0].qrcodedata=this.qrcodedata,console.log(this.qrcodedata)}stringToHex(e){let i="";for(let s=0;s<e.length;s++)i+=this.toHex(e.charCodeAt(s));return i}toHex(e){return e.toString(16).toUpperCase()}prepareQrcode2(){console.log("prepareQrcode");const s=(0,v.p6)(this.payInvo.pay_date,"yyyy-MM-dd","en-US")+"T"+this.payInvo.pay_time+"Z";console.log(s);const o=new TextEncoder;o.encode(),console.log(o.encode());let l=this.toHexTagAndLenght(this.company.engName.length);1==l.length&&(l="0"+l);const d=this.stringToHexAscii("01")+this.stringToHexAscii(l)+this.company.engName;console.log("companylengthhex : "+l,"companylengthhexAscii : "+this.stringToHexAscii(l),"tagAscii : "+this.stringToHexAscii("01"));let m=this.toHexTagAndLenght(this.company.vatNo.length);1==m.length&&(m="0"+m);const y=this.stringToHexAscii("02")+this.stringToHexAscii(m)+this.company.vatNo.toString();console.log("Vatlengthhex : "+m,"companyVatlengthhexAscii : "+this.stringToHexAscii(m),"tagAscii : "+this.stringToHexAscii("02"));let g=this.toHexTagAndLenght(s.length);1==g.length&&(g="0"+g);const A=this.stringToHexAscii("03")+this.stringToHexAscii(g)+s.toString();console.log("datelengthhex : "+g,"datelengthhexAscii : "+this.stringToHexAscii(g),"tagAscii : "+this.stringToHexAscii("03")),console.log("taxAll",typeof this.taxAll,this.taxAll);let _=this.toHexTagAndLenght(this.taxAll.length);1==_.length&&(_="0"+_);const T=this.stringToHexAscii("04")+this.stringToHexAscii(_)+this.taxAll.toString();console.log("totalengthhex : "+_,"totAlengthhexAscii : "+this.stringToHexAscii(_),"tagAscii : "+this.stringToHexAscii("04")),console.log("totax",typeof this.payInvo.taxTot,this.payInvo.taxTot);let p=this.toHexTagAndLenght(this.payInvo.taxTot.toString().length);1==p.length&&(p="0"+p);const Z=this.stringToHexAscii("05")+this.stringToHexAscii(p)+this.payInvo.taxTot.toString();console.log("taxlengthhex : "+p,"TAXlengthhexAscii : "+this.stringToHexAscii(p),"tagAscii : "+this.stringToHexAscii("05")),console.log(d+y+A+T+Z);const C=btoa(d+y+A+T+Z);this.qrcodedata=C,this.printArr[0].qrcodedata=this.qrcodedata,console.log(this.qrcodedata)}stringToHexAscii(e){let i="";for(let s=0;s<e.length;s+=2)i+=String.fromCharCode(parseInt(e.substr(s,2),16));return i}toHexTagAndLenght(e){return e.toString(16).toUpperCase()}presentModal(e,i){return(0,I.mG)(this,void 0,void 0,function*(){const s=yield this.modalController.create({component:M.n,componentProps:{printArr:this.printArr,page:i}});return s.onDidDismiss().then(o=>{null!==o&&this.prepareInvo()}),yield s.present()})}presentLoadingWithOptions(e){return(0,I.mG)(this,void 0,void 0,function*(){const i=yield this.loadingController.create({spinner:"bubbles",mode:"ios",duration:5e3,message:e,translucent:!0,backdropDismiss:!1});yield i.present(),yield i.onDidDismiss()})}}return n.\u0275fac=function(e){return new(e||n)(t.Y36(a._q),t.Y36(H.H7),t.Y36(q.F0),t.Y36(a.t4),t.Y36(Q.h),t.Y36(v.Ye),t.Y36(q.gz),t.Y36(t.Qsj),t.Y36(a.IN),t.Y36(a.Br),t.Y36(N.u),t.Y36(O.K),t.Y36(a.HT),t.Y36(v.uU),t.Y36(F.r),t.Y36(a.yF))},n.\u0275cmp=t.Xpm({type:n,selectors:[["app-pos-sales"]],viewQuery:function(e,i){if(1&e&&(t.Gf(U,5),t.Gf(k,5),t.Gf(J,5),t.Gf(R,5),t.Gf(Y,5),t.Gf(B,5)),2&e){let s;t.iGM(s=t.CRH())&&(i.nameField=s.first),t.iGM(s=t.CRH())&&(i.dstPop=s.first),t.iGM(s=t.CRH())&&(i.qtyId=s.first),t.iGM(s=t.CRH())&&(i.popInput=s.first),t.iGM(s=t.CRH())&&(i.popover=s.first),t.iGM(s=t.CRH())&&(i.popoverNotif=s.first)}},decls:13,vars:2,consts:[["slot","start"],["slot","end"],[1,"poRel"],[4,"ngIf"],["dir","rtl"],["class","ion-justify-content-end",4,"ngIf"],["size","12",1,"ion-no-padding"],["size","5"],[1,"items-container2"],[3,"isOpen","didDismiss"],["popoverNotif",""],[1,"table"],["style","cursor: pointer;",3,"click",4,"ngFor","ngForOf"],["size","3",1,"ion-margin-top"],["size","3",1,"totaClass","dash"],["size","7"],["class","cardContainer",4,"ngIf"],["dir","rtl",1,"ion-text-center"],["class","custInput",4,"ngIf"],[1,"ion-text-center"],["lines","none","button","",3,"click",4,"ngFor","ngForOf"],[1,"custInput"],[2,"text-align","center",3,"ngModel","keyup.enter","ngModelChange","ionBlur"],["lines","none","button","",3,"click"],["size","9",1,"ion-text-center"],["color","dark"],[2,"cursor","pointer",3,"click"],["fill","clear","size","small",3,"click"],["name","trash","color","danger"],[2,"max-width","100px","overflow","hidden","white-space","normal"],[1,"cardContainer"],[2,"width","100%"],["scrollable","true",1,"seg",3,"ionChange"],[3,"value",4,"ngFor","ngForOf"],[1,"items-container"],[3,"value"],["size","3","class","cardImg",4,"ngFor","ngForOf"],["size","3",1,"cardImg"],[1,"price-tag"],[3,"click"],["alt","",3,"src"],[1,"item-title"],[1,"ion-justify-content-end"],["size","9",1,"ion-no-padding"],["size","4","dir","ltr"],[3,"ngModel","ngModelChange"],["lines","none"],[1,"radioLbl"],["value","cash"],["value","card"],["size","2"],[1,"ion-padding"],[3,"ngModel","ngModelChange","ionChange"],[3,"ngModel","readonly","ngModelChange"],["expand","block","routerDirection","root","color","primary",1,"custButton",3,"click"],["name","checkmark-sharp","color","light","slot","end"]],template:function(e,i){1&e&&(t.TgZ(0,"ion-header"),t.TgZ(1,"ion-toolbar"),t.TgZ(2,"ion-buttons",0),t._UZ(3,"ion-menu-button"),t.qZA(),t.TgZ(4,"ion-title"),t._uU(5,"\u0641\u0627\u062a\u0648\u0631\u0629 \u0645\u0628\u064a\u0639\u0627\u062a"),t.qZA(),t.TgZ(6,"ion-buttons",1),t._UZ(7,"div",2),t.qZA(),t.qZA(),t.qZA(),t.TgZ(8,"ion-content"),t.YNc(9,K,62,7,"ion-grid",3),t.qZA(),t.TgZ(10,"ion-footer"),t.TgZ(11,"ion-grid",4),t.YNc(12,X,36,5,"ion-row",5),t.qZA(),t.qZA()),2&e&&(t.xp6(9),t.Q6J("ngIf",i.user_info&&i.store_info),t.xp6(3),t.Q6J("ngIf",i.payInvo))},directives:[a.Gu,a.sr,a.Sm,a.fG,a.wd,a.W2,v.O5,a.fr,a.jY,a.Nd,a.wI,a.PM,a.d8,v.sg,a.Q$,a.yW,a.q_,a.Ie,a.pK,a.j9,L.JJ,L.On,a.YG,a.gu,a.cJ,a.QI,a.GO,a.se,a.B7,a.U5],styles:[".custInput[_ngcontent-%COMP%]{border-style:solid;border-color:var(--ion-color-light);border-radius:5px}.cust-card[_ngcontent-%COMP%]{border-radius:5px}.show[_ngcontent-%COMP%]{visibility:visible}.hide[_ngcontent-%COMP%]{visibility:hidden}.custRow[_ngcontent-%COMP%]{margin-top:5rem}.bnone[_ngcontent-%COMP%]{border:none}.items-container[_ngcontent-%COMP%]{overflow:auto;white-space:nowrap;min-height:371px;max-height:300px}.items-container2[_ngcontent-%COMP%]{overflow:auto;white-space:nowrap;min-height:385px;max-height:385px}.item-title[_ngcontent-%COMP%]{text-overflow:ellipsis;display:block;white-space:normal}.cardImg[_ngcontent-%COMP%]{position:relative;cursor:pointer}.price-tag[_ngcontent-%COMP%]{position:absolute;top:-6px;right:0;background-color:var(--ion-color-primary);padding:5px;border-radius:5px;color:#fffdfd}.totaClass[_ngcontent-%COMP%]{font-size:18px;font-weight:700;text-align:center;color:#000}.cardContainer[_ngcontent-%COMP%]{height:100%}.custButton[_ngcontent-%COMP%]{height:85%;font-size:30px;font-weight:bolder}.radioLbl[_ngcontent-%COMP%]{text-align:right;padding:14px}.seg[_ngcontent-%COMP%]{border-style:solid;border-color:var(--ion-color-light)}.dash[_ngcontent-%COMP%]{border-style:dashed;border-color:var(--ion-color-primary);border-width:.8px}ion-segment[_ngcontent-%COMP%]{overflow-x:auto;overflow-y:hidden;white-space:nowrap}ion-segment-button[_ngcontent-%COMP%]{display:inline-block}.red[_ngcontent-%COMP%]{color:var(--ion-color-danger)}.darko[_ngcontent-%COMP%]{color:var(--ion-color-dark)}ion-popover[_ngcontent-%COMP%]{--offset-y: -30px }.custInp[_ngcontent-%COMP%]{border-right-style:solid;border-right-width:.5px;text-align:center}.table[_ngcontent-%COMP%]{text-align:center;width:100%;margin:12px}tr[_ngcontent-%COMP%]:nth-child(even){background-color:#ddd}td[_ngcontent-%COMP%], th[_ngcontent-%COMP%]{border:1px solid #dddddd;text-align:center;padding:8px;font-size:14px;font-weight:700;color:#000}"]}),n})()}];let et=(()=>{class n{}return n.\u0275fac=function(e){return new(e||n)},n.\u0275mod=t.oAB({type:n}),n.\u0275inj=t.cJS({imports:[[q.Bz.forChild(tt)],q.Bz]}),n})();var it=h(5174);let st=(()=>{class n{}return n.\u0275fac=function(e){return new(e||n)},n.\u0275mod=t.oAB({type:n}),n.\u0275inj=t.cJS({imports:[[v.ez,L.u5,a.Pc,it.NY,et]]}),n})()}}]);